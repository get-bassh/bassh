#!/bin/bash

# share-site: Deploy static sites via shared Cloudflare infrastructure
# Users don't need their own Cloudflare account - deploys to your worker

set -e

# ============================================================
# CONFIGURATION
# ============================================================
WORKER_URL="${SHARE_SITE_API:-}"
API_KEY="${SHARE_SITE_KEY:-}"
# ============================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Defaults
DIR="."
PASSWORD=""
PROJECT_NAME=""
EMAILS=""
DOMAIN=""
DELETE_MODE=false
LIST_MODE=false
REGISTER_MODE=false
ME_MODE=false
UNINSTALL_MODE=false
REGISTER_USERNAME=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    register)
      REGISTER_MODE=true
      REGISTER_USERNAME="${2:-}"
      if [[ -n "$2" ]]; then
        shift 2
      else
        shift 1
      fi
      ;;
    me)
      ME_MODE=true
      shift
      ;;
    uninstall)
      UNINSTALL_MODE=true
      shift
      ;;
    --password|-p)
      PASSWORD="$2"
      shift 2
      ;;
    --name|-n)
      PROJECT_NAME="$2"
      shift 2
      ;;
    --emails|-e)
      EMAILS="$2"
      shift 2
      ;;
    --domain|-d)
      DOMAIN="$2"
      shift 2
      ;;
    --delete|-D)
      DELETE_MODE=true
      shift
      ;;
    --list|-l)
      LIST_MODE=true
      shift
      ;;
    --help|-h)
      echo "share-site - Deploy a static site in one command"
      echo ""
      echo "Usage: share-site [command] [directory] [options]"
      echo ""
      echo "Commands:"
      echo "  register <username>       Create an account and get API key"
      echo "  me                        Show current user info"
      echo "  uninstall                 Delete account, all sites, and remove CLI"
      echo ""
      echo "Options:"
      echo "  -p, --password <pass>     Add AES-256-GCM encrypted password protection"
      echo "  -e, --emails <list>       Restrict to specific emails (comma-separated)"
      echo "  -d, --domain <domain>     Allow all emails from domain (e.g., @company.com)"
      echo "  -n, --name <name>         Project name (auto-generated if not provided)"
      echo "  -l, --list                List your projects"
      echo "  -D, --delete              Delete a project (requires -n)"
      echo "  -h, --help                Show this help"
      echo ""
      echo "Examples:"
      echo "  share-site register alice           # Create account, get API key"
      echo "  share-site me                       # Show your username"
      echo "  share-site                          # Deploy current directory"
      echo "  share-site ./my-site                # Deploy specific directory"
      echo "  share-site -p secret123             # With password"
      echo "  share-site -e \"a@x.com,b@y.com\"     # Only these emails can access"
      echo "  share-site -d \"@company.com\"        # Anyone @company.com can access"
      echo "  share-site -l                       # List your projects"
      echo "  share-site -D -n my-project         # Delete a project"
      echo "  share-site uninstall                # Remove account and all data"
      echo ""
      echo "Environment:"
      echo "  SHARE_SITE_API    The deployment API URL"
      echo "  SHARE_SITE_KEY    Your API key (from 'share-site register')"
      exit 0
      ;;
    *)
      DIR="$1"
      shift
      ;;
  esac
done

# Check worker URL is configured
if [[ -z "$WORKER_URL" ]]; then
  echo -e "${RED}Error: Worker URL not configured${NC}"
  echo ""
  echo "Set your worker URL:"
  echo "  export SHARE_SITE_API=https://your-worker.workers.dev"
  echo ""
  echo "Add to ~/.zshrc or ~/.bashrc to make permanent."
  exit 1
fi

# Handle register mode
if [[ "$REGISTER_MODE" == true ]]; then
  if [[ -z "$REGISTER_USERNAME" ]]; then
    echo -e "${RED}Error: Username required${NC}"
    echo "Usage: share-site register <username>"
    exit 1
  fi

  echo -e "${BLUE}Registering user: $REGISTER_USERNAME${NC}"

  # Check for registration code
  REGISTRATION_CODE=""
  if [[ -n "$SHARE_SITE_REGISTRATION_CODE" ]]; then
    REGISTRATION_CODE="$SHARE_SITE_REGISTRATION_CODE"
  else
    echo -n -e "${YELLOW}Enter registration code (or press Enter if not required): ${NC}"
    read -r REGISTRATION_CODE
  fi

  RESPONSE=$(curl -s -X POST "$WORKER_URL/register" \
    -H "Content-Type: application/json" \
    -d "{\"username\": \"$REGISTER_USERNAME\", \"registrationCode\": \"$REGISTRATION_CODE\"}") || true

  if [[ -z "$RESPONSE" ]]; then
    echo -e "${RED}Error: No response from server${NC}"
    exit 1
  fi

  if echo "$RESPONSE" | grep -q '"success":true'; then
    API_KEY=$(echo "$RESPONSE" | grep -oE '"key":"[^"]+"' | cut -d'"' -f4)
    echo ""
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${GREEN}✓ Registration successful!${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo ""
    echo -e "  ${BLUE}Username:${NC} $REGISTER_USERNAME"
    echo -e "  ${BLUE}API Key:${NC}  $API_KEY"
    echo ""

    # Determine shell config file
    if [[ -f "$HOME/.zshrc" ]]; then
      SHELL_RC="$HOME/.zshrc"
    else
      SHELL_RC="$HOME/.bashrc"
    fi

    # Offer to save automatically
    echo -n -e "${YELLOW}Save API key to $SHELL_RC? (Y/n): ${NC}"
    read -r SAVE_KEY
    if [[ "$SAVE_KEY" != "n" && "$SAVE_KEY" != "N" ]]; then
      # Remove old key if exists
      sed -i '' '/SHARE_SITE_KEY/d' "$SHELL_RC" 2>/dev/null || sed -i '/SHARE_SITE_KEY/d' "$SHELL_RC"
      echo "export SHARE_SITE_KEY=\"$API_KEY\"" >> "$SHELL_RC"
      echo -e "${GREEN}✓ API key saved to $SHELL_RC${NC}"
      echo ""
      echo -e "Run: ${CYAN}source $SHELL_RC${NC}"
    else
      echo ""
      echo -e "${YELLOW}Save your API key! It cannot be recovered.${NC}"
      echo ""
      echo "Add to your shell config:"
      echo -e "  ${CYAN}export SHARE_SITE_KEY=$API_KEY${NC}"
    fi
    echo ""
  else
    ERROR=$(echo "$RESPONSE" | grep -oE '"error":"[^"]+"' | cut -d'"' -f4)
    echo -e "${RED}Registration failed: $ERROR${NC}"
    exit 1
  fi
  exit 0
fi

# Handle me mode
if [[ "$ME_MODE" == true ]]; then
  if [[ -z "$API_KEY" ]]; then
    echo -e "${RED}Error: API key not configured${NC}"
    echo ""
    echo "Set your API key:"
    echo "  export SHARE_SITE_KEY=sk_your_key_here"
    echo ""
    echo "Or register first:"
    echo "  share-site register <username>"
    exit 1
  fi

  RESPONSE=$(curl -s -X GET "$WORKER_URL/me" \
    -H "X-API-Key: $API_KEY")

  if echo "$RESPONSE" | grep -q '"success":true'; then
    USERNAME=$(echo "$RESPONSE" | grep -oE '"username":"[^"]+"' | cut -d'"' -f4)
    CREATED=$(echo "$RESPONSE" | grep -oE '"created":"[^"]+"' | cut -d'"' -f4)
    echo ""
    echo -e "${GREEN}Logged in as:${NC} $USERNAME"
    echo -e "${BLUE}Created:${NC} $CREATED"
    echo ""
  else
    echo -e "${RED}Invalid API key${NC}"
    exit 1
  fi
  exit 0
fi

# Handle uninstall mode
if [[ "$UNINSTALL_MODE" == true ]]; then
  if [[ -z "$API_KEY" ]]; then
    echo -e "${RED}Error: API key not configured${NC}"
    echo ""
    echo "Set your API key:"
    echo "  export SHARE_SITE_KEY=sk_your_key_here"
    exit 1
  fi

  # Get user info first
  ME_RESPONSE=$(curl -s -X GET "$WORKER_URL/me" \
    -H "X-API-Key: $API_KEY")

  if ! echo "$ME_RESPONSE" | grep -q '"success":true'; then
    echo -e "${RED}Invalid API key${NC}"
    exit 1
  fi

  USERNAME=$(echo "$ME_RESPONSE" | grep -oE '"username":"[^"]+"' | cut -d'"' -f4)

  # Get projects for display
  LIST_RESPONSE=$(curl -s -X GET "$WORKER_URL" \
    -H "X-API-Key: $API_KEY")

  echo ""
  echo -e "${RED}════════════════════════════════════════${NC}"
  echo -e "${RED}       UNINSTALL share-site${NC}"
  echo -e "${RED}════════════════════════════════════════${NC}"
  echo ""
  echo -e "${YELLOW}This will permanently delete:${NC}"
  echo ""
  echo -e "  ${BLUE}•${NC} Your account: ${CYAN}$USERNAME${NC}"

  # Show projects if any
  if echo "$LIST_RESPONSE" | grep -q '"shortName"'; then
    echo -e "  ${BLUE}•${NC} All your Cloudflare Pages projects:"
    echo "$LIST_RESPONSE" | grep -oE '"shortName":"[^"]+"' | cut -d'"' -f4 | while read -r name; do
      echo -e "      - $name"
    done
  fi

  echo -e "  ${BLUE}•${NC} Associated Cloudflare Access policies"
  echo -e "  ${BLUE}•${NC} Your API key from shell config"
  echo ""
  echo -e "${RED}This action cannot be undone!${NC}"
  echo ""
  echo -n -e "${YELLOW}Type 'DELETE' to confirm: ${NC}"
  read -r CONFIRM

  if [[ "$CONFIRM" != "DELETE" ]]; then
    echo -e "${BLUE}Uninstall cancelled.${NC}"
    exit 0
  fi

  echo ""
  echo -e "${BLUE}Removing cloud resources...${NC}"

  RESPONSE=$(curl -s -X POST "$WORKER_URL/uninstall" \
    -H "X-API-Key: $API_KEY" \
    -H "Content-Type: application/json")

  if echo "$RESPONSE" | grep -q '"success":true'; then
    PROJECTS_COUNT=$(echo "$RESPONSE" | grep -oE '"projectsCount":[0-9]+' | cut -d':' -f2)
    APPS_COUNT=$(echo "$RESPONSE" | grep -oE '"appsCount":[0-9]+' | cut -d':' -f2)

    echo -e "${GREEN}✓ Deleted $PROJECTS_COUNT project(s)${NC}"
    echo -e "${GREEN}✓ Deleted $APPS_COUNT access app(s)${NC}"
    echo -e "${GREEN}✓ Deleted user account${NC}"

    # Remove API key from shell config
    if [[ -f "$HOME/.zshrc" ]]; then
      SHELL_RC="$HOME/.zshrc"
    else
      SHELL_RC="$HOME/.bashrc"
    fi

    if grep -q "SHARE_SITE_KEY" "$SHELL_RC" 2>/dev/null; then
      sed -i '' '/SHARE_SITE_KEY/d' "$SHELL_RC" 2>/dev/null || sed -i '/SHARE_SITE_KEY/d' "$SHELL_RC"
      echo -e "${GREEN}✓ Removed API key from $SHELL_RC${NC}"
    fi

    echo ""
    echo -n -e "${YELLOW}Remove CLI script from system? (y/N): ${NC}"
    read -r REMOVE_CLI

    if [[ "$REMOVE_CLI" == "y" || "$REMOVE_CLI" == "Y" ]]; then
      CLI_PATH=$(which share-site 2>/dev/null || echo "")
      if [[ -n "$CLI_PATH" && -f "$CLI_PATH" ]]; then
        rm -f "$CLI_PATH" 2>/dev/null && echo -e "${GREEN}✓ Removed CLI from $CLI_PATH${NC}" || echo -e "${YELLOW}Could not remove $CLI_PATH (may need sudo)${NC}"
      else
        echo -e "${BLUE}CLI not found in PATH, skipping${NC}"
      fi
    fi

    echo ""
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${GREEN}Uninstall complete!${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo ""
  else
    ERROR=$(echo "$RESPONSE" | grep -oE '"error":"[^"]+"' | cut -d'"' -f4)
    echo -e "${RED}Uninstall failed: $ERROR${NC}"
    echo "Response: $RESPONSE"
    exit 1
  fi
  exit 0
fi

# All other operations require API key
if [[ -z "$API_KEY" ]]; then
  echo -e "${RED}Error: API key not configured${NC}"
  echo ""
  echo "Set your API key:"
  echo "  export SHARE_SITE_KEY=sk_your_key_here"
  echo ""
  echo "Or register first:"
  echo "  share-site register <username>"
  exit 1
fi

# Handle list mode
if [[ "$LIST_MODE" == true ]]; then
  RESPONSE=$(curl -s -X GET "$WORKER_URL" \
    -H "X-API-Key: $API_KEY")

  if echo "$RESPONSE" | grep -q '"success":true'; then
    USERNAME=$(echo "$RESPONSE" | grep -oE '"username":"[^"]+"' | cut -d'"' -f4)
    echo -e "${GREEN}Projects for $USERNAME:${NC}"
    echo ""

    # Parse projects - extract shortName and url pairs
    echo "$RESPONSE" | grep -oE '"shortName":"[^"]+"|"url":"[^"]+"' | while read -r line; do
      if [[ "$line" == *'"shortName"'* ]]; then
        NAME=$(echo "$line" | cut -d'"' -f4)
        echo -e "  ${BLUE}•${NC} $NAME"
      elif [[ "$line" == *'"url"'* ]]; then
        URL=$(echo "$line" | cut -d'"' -f4)
        echo -e "    ${CYAN}$URL${NC}"
      fi
    done
    echo ""
  else
    echo -e "${RED}Failed to list projects${NC}"
    echo "Response: $RESPONSE"
    exit 1
  fi
  exit 0
fi

# Handle delete mode
if [[ "$DELETE_MODE" == true ]]; then
  if [[ -z "$PROJECT_NAME" ]]; then
    echo -e "${RED}Error: Project name required for delete. Use -n <name>${NC}"
    exit 1
  fi

  echo -e "${BLUE}Deleting project: $PROJECT_NAME${NC}"

  RESPONSE=$(curl -s -X DELETE "$WORKER_URL" \
    -H "Content-Type: application/json" \
    -H "X-API-Key: $API_KEY" \
    -H "X-Project-Name: $PROJECT_NAME")

  if echo "$RESPONSE" | grep -q '"success":true'; then
    echo -e "${GREEN}✓ Project '$PROJECT_NAME' deleted successfully${NC}"
  else
    echo -e "${RED}Delete failed${NC}"
    echo "Response: $RESPONSE"
    exit 1
  fi
  exit 0
fi

# Check if directory exists
if [[ ! -d "$DIR" ]]; then
  echo -e "${RED}Error: Directory '$DIR' not found${NC}"
  exit 1
fi

# Check for required tools
if ! command -v curl &> /dev/null; then
  echo -e "${RED}Error: 'curl' command not found. Please install it.${NC}"
  exit 1
fi

if ! command -v base64 &> /dev/null; then
  echo -e "${RED}Error: 'base64' command not found. Please install it.${NC}"
  exit 1
fi

# Generate project name if not provided
if [[ -z "$PROJECT_NAME" ]]; then
  PROJECT_NAME="site-$(date +%s | tail -c 6)"
fi

# Create temp directory for processing
TEMP_DIR=$(mktemp -d)
DEPLOY_DIR="$TEMP_DIR/deploy"
JSON_FILE="$TEMP_DIR/payload.json"

mkdir -p "$DEPLOY_DIR"

# Copy files
cp -r "$DIR"/* "$DEPLOY_DIR"/ 2>/dev/null || cp -r "$DIR"/. "$DEPLOY_DIR"/

# Auto-create index.html if missing
if [[ ! -f "$DEPLOY_DIR/index.html" ]]; then
  FIRST_HTML=$(find "$DEPLOY_DIR" -maxdepth 1 -name "*.html" -type f | head -1)
  if [[ -n "$FIRST_HTML" ]]; then
    cp "$FIRST_HTML" "$DEPLOY_DIR/index.html"
    echo -e "${BLUE}No index.html found, using $(basename "$FIRST_HTML")${NC}"
  fi
fi

# Password protection is now handled server-side with AES-256-GCM encryption
if [[ -n "$PASSWORD" ]]; then
  echo -e "${BLUE}Password protection enabled (AES-256-GCM encryption)${NC}"
fi

# Build JSON payload with files
echo -e "${BLUE}Packaging site...${NC}"

cd "$DEPLOY_DIR"

# Collect all files into an array
FILES=()
while IFS= read -r -d '' file; do
  FILES+=("$file")
done < <(find . -type f -print0)

# Build JSON
echo -n '{"files":[' > "$JSON_FILE"

for i in "${!FILES[@]}"; do
  file="${FILES[$i]}"
  # Remove leading ./
  FILEPATH="${file#./}"

  # Base64 encode the file content
  CONTENT=$(base64 < "$file" | tr -d '\n')

  if [ $i -gt 0 ]; then
    echo -n "," >> "$JSON_FILE"
  fi

  # Write JSON object
  printf '{"path":"%s","content":"%s"}' "$FILEPATH" "$CONTENT" >> "$JSON_FILE"
done

echo ']}' >> "$JSON_FILE"

cd - > /dev/null

# Upload to worker
echo -e "${BLUE}Deploying to Cloudflare Pages...${NC}"
echo ""

RESPONSE=$(curl -s -X POST "$WORKER_URL" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: $API_KEY" \
  -H "X-Project-Name: $PROJECT_NAME" \
  -H "X-Password: $PASSWORD" \
  -H "X-Emails: $EMAILS" \
  -H "X-Domain: $DOMAIN" \
  --data-binary "@$JSON_FILE")

# Cleanup
rm -rf "$TEMP_DIR"

# Parse response
if echo "$RESPONSE" | grep -q '"success":true'; then
  URL=$(echo "$RESPONSE" | grep -oE '"url":"[^"]+' | head -1 | cut -d'"' -f4)
  PROJECT=$(echo "$RESPONSE" | grep -oE '"project":"[^"]+' | cut -d'"' -f4)
  SHORT_NAME=$(echo "$RESPONSE" | grep -oE '"shortName":"[^"]+' | cut -d'"' -f4)

  echo -e "${GREEN}════════════════════════════════════════${NC}"
  echo -e "${GREEN}✓ Site deployed successfully!${NC}"
  echo -e "${GREEN}════════════════════════════════════════${NC}"
  echo ""
  echo -e "  ${BLUE}URL:${NC} $URL"
  echo -e "  ${BLUE}Project:${NC} $SHORT_NAME"

  if [[ -n "$PASSWORD" ]]; then
    echo -e "  ${BLUE}Password:${NC} $PASSWORD"
  fi

  if [[ -n "$EMAILS" ]]; then
    echo -e "  ${BLUE}Allowed emails:${NC} $EMAILS"
  fi

  if [[ -n "$DOMAIN" ]]; then
    echo -e "  ${BLUE}Allowed domain:${NC} $DOMAIN"
  fi

  if [[ -n "$EMAILS" || -n "$DOMAIN" ]]; then
    echo ""
    echo -e "  ${CYAN}Visitors will verify via email before accessing.${NC}"
  fi

  echo ""
else
  echo -e "${RED}Deployment failed${NC}"
  echo ""
  echo "Response: $RESPONSE"
  exit 1
fi
